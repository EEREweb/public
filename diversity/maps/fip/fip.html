
<!DOCTYPE html>
<title>Formerly Incarcerated Persons Map | Department of Energy</title>
<meta charset="UTF-8">

<script src='//api.mapbox.com/mapbox.js/v3.0.1/mapbox.js'></script>
<link href='//api.mapbox.com/mapbox.js/v3.0.1/mapbox.css' rel='stylesheet' />

<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//www1.eere.energy.gov/apps/js/jquery/3.2.0/jquery.min.js"></script>
<script src="//www1.eere.energy.gov/apps/js/bootstrap/3.3.7/bootstrap.min.js"></script>
<script src="//www1.eere.energy.gov/apps/js/papaparse/4.1.2/papaparse.min.js"></script>
<script src="//www1.eere.energy.gov/apps/js/datatables/1.10.15/jquery.dataTables.min.js"></script>
<script src="//www1.eere.energy.gov/apps/js/bootstrap-multiselect/2.0/bootstrapMultiselect.src.js"></script>

<script src="states.js"></script>
<script src="//www1.eere.energy.gov/apps/js/funclib.js"></script>

<script>
/*
 Leaflet.markercluster, Provides Beautiful Animated Marker Clustering functionality for Leaflet, a JS library for interactive maps.
 https://github.com/Leaflet/Leaflet.markercluster
 (c) 2012-2013, Dave Leaver, smartrak
*/
!function (e, t, i) { L.MarkerClusterGroup = L.FeatureGroup.extend({ options: { maxClusterRadius: 80, iconCreateFunction: null, spiderfyOnMaxZoom: !0, showCoverageOnHover: !0, zoomToBoundsOnClick: !0, singleMarkerMode: !1, disableClusteringAtZoom: null, removeOutsideVisibleBounds: !0, animate: !0, animateAddingMarkers: !1, spiderfyDistanceMultiplier: 1, spiderLegPolylineOptions: { weight: 1.5, color: "#222", opacity: .5 }, chunkedLoading: !1, chunkInterval: 200, chunkDelay: 50, chunkProgress: null, polygonOptions: {} }, initialize: function (e) { L.Util.setOptions(this, e), this.options.iconCreateFunction || (this.options.iconCreateFunction = this._defaultIconCreateFunction), this._featureGroup = L.featureGroup(), this._featureGroup.addEventParent(this), this._nonPointGroup = L.featureGroup(), this._nonPointGroup.addEventParent(this), this._inZoomAnimation = 0, this._needsClustering = [], this._needsRemoving = [], this._currentShownBounds = null, this._queue = []; var t = L.DomUtil.TRANSITION && this.options.animate; L.extend(this, t ? this._withAnimation : this._noAnimation), this._markerCluster = t ? L.MarkerCluster : L.MarkerClusterNonAnimated }, addLayer: function (e) { if (e instanceof L.LayerGroup) return this.addLayers([e]); if (!e.getLatLng) return this._nonPointGroup.addLayer(e), this; if (!this._map) return this._needsClustering.push(e), this; if (this.hasLayer(e)) return this; this._unspiderfy && this._unspiderfy(), this._addLayer(e, this._maxZoom), this._topClusterLevel._recalculateBounds(), this._refreshClustersIcons(); var t = e, i = this._zoom; if (e.__parent) for (; t.__parent._zoom >= i;) t = t.__parent; return this._currentShownBounds.contains(t.getLatLng()) && (this.options.animateAddingMarkers ? this._animationAddLayer(e, t) : this._animationAddLayerNonAnimated(e, t)), this }, removeLayer: function (e) { return e instanceof L.LayerGroup ? this.removeLayers([e]) : e.getLatLng ? this._map ? e.__parent ? (this._unspiderfy && (this._unspiderfy(), this._unspiderfyLayer(e)), this._removeLayer(e, !0), this._topClusterLevel._recalculateBounds(), this._refreshClustersIcons(), e.off("move", this._childMarkerMoved, this), this._featureGroup.hasLayer(e) && (this._featureGroup.removeLayer(e), e.clusterShow && e.clusterShow()), this) : this : (!this._arraySplice(this._needsClustering, e) && this.hasLayer(e) && this._needsRemoving.push(e), this) : (this._nonPointGroup.removeLayer(e), this) }, addLayers: function (e) { if (!L.Util.isArray(e)) return this.addLayer(e); var t, i = this._featureGroup, n = this._nonPointGroup, s = this.options.chunkedLoading, r = this.options.chunkInterval, o = this.options.chunkProgress, a = e.length, h = 0, u = !0; if (this._map) { var l = (new Date).getTime(), _ = L.bind(function () { for (var d = (new Date).getTime() ; a > h; h++) { if (s && 0 === h % 200) { var c = (new Date).getTime() - d; if (c > r) break } if (t = e[h], t instanceof L.LayerGroup) u && (e = e.slice(), u = !1), this._extractNonGroupLayers(t, e), a = e.length; else if (t.getLatLng) { if (!this.hasLayer(t) && (this._addLayer(t, this._maxZoom), t.__parent && 2 === t.__parent.getChildCount())) { var p = t.__parent.getAllChildMarkers(), f = p[0] === t ? p[1] : p[0]; i.removeLayer(f) } } else n.addLayer(t) } o && o(h, a, (new Date).getTime() - l), h === a ? (this._topClusterLevel._recalculateBounds(), this._refreshClustersIcons(), this._topClusterLevel._recursivelyAddChildrenToMap(null, this._zoom, this._currentShownBounds)) : setTimeout(_, this.options.chunkDelay) }, this); _() } else for (var d = this._needsClustering; a > h; h++) t = e[h], t instanceof L.LayerGroup ? (u && (e = e.slice(), u = !1), this._extractNonGroupLayers(t, e), a = e.length) : t.getLatLng ? this.hasLayer(t) || d.push(t) : n.addLayer(t); return this }, removeLayers: function (e) { var t, i, n = e.length, s = this._featureGroup, r = this._nonPointGroup, o = !0; if (!this._map) { for (t = 0; n > t; t++) i = e[t], i instanceof L.LayerGroup ? (o && (e = e.slice(), o = !1), this._extractNonGroupLayers(i, e), n = e.length) : (this._arraySplice(this._needsClustering, i), r.removeLayer(i), this.hasLayer(i) && this._needsRemoving.push(i)); return this } if (this._unspiderfy) { this._unspiderfy(); var a = e.slice(), h = n; for (t = 0; h > t; t++) i = a[t], i instanceof L.LayerGroup ? (this._extractNonGroupLayers(i, a), h = a.length) : this._unspiderfyLayer(i) } for (t = 0; n > t; t++) i = e[t], i instanceof L.LayerGroup ? (o && (e = e.slice(), o = !1), this._extractNonGroupLayers(i, e), n = e.length) : i.__parent ? (this._removeLayer(i, !0, !0), s.hasLayer(i) && (s.removeLayer(i), i.clusterShow && i.clusterShow())) : r.removeLayer(i); return this._topClusterLevel._recalculateBounds(), this._refreshClustersIcons(), this._topClusterLevel._recursivelyAddChildrenToMap(null, this._zoom, this._currentShownBounds), this }, clearLayers: function () { return this._map || (this._needsClustering = [], delete this._gridClusters, delete this._gridUnclustered), this._noanimationUnspiderfy && this._noanimationUnspiderfy(), this._featureGroup.clearLayers(), this._nonPointGroup.clearLayers(), this.eachLayer(function (e) { e.off("move", this._childMarkerMoved, this), delete e.__parent }), this._map && this._generateInitialClusters(), this }, getBounds: function () { var e = new L.LatLngBounds; this._topClusterLevel && e.extend(this._topClusterLevel._bounds); for (var t = this._needsClustering.length - 1; t >= 0; t--) e.extend(this._needsClustering[t].getLatLng()); return e.extend(this._nonPointGroup.getBounds()), e }, eachLayer: function (e, t) { var i, n = this._needsClustering.slice(), s = this._needsRemoving; for (this._topClusterLevel && this._topClusterLevel.getAllChildMarkers(n), i = n.length - 1; i >= 0; i--) -1 === s.indexOf(n[i]) && e.call(t, n[i]); this._nonPointGroup.eachLayer(e, t) }, getLayers: function () { var e = []; return this.eachLayer(function (t) { e.push(t) }), e }, getLayer: function (e) { var t = null; return e = parseInt(e, 10), this.eachLayer(function (i) { L.stamp(i) === e && (t = i) }), t }, hasLayer: function (e) { if (!e) return !1; var t, i = this._needsClustering; for (t = i.length - 1; t >= 0; t--) if (i[t] === e) return !0; for (i = this._needsRemoving, t = i.length - 1; t >= 0; t--) if (i[t] === e) return !1; return !(!e.__parent || e.__parent._group !== this) || this._nonPointGroup.hasLayer(e) }, zoomToShowLayer: function (e, t) { "function" != typeof t && (t = function () { }); var i = function () { !e._icon && !e.__parent._icon || this._inZoomAnimation || (this._map.off("moveend", i, this), this.off("animationend", i, this), e._icon ? t() : e.__parent._icon && (this.once("spiderfied", t, this), e.__parent.spiderfy())) }; if (e._icon && this._map.getBounds().contains(e.getLatLng())) t(); else if (e.__parent._zoom < Math.round(this._map._zoom)) this._map.on("moveend", i, this), this._map.panTo(e.getLatLng()); else { var n = function () { this._map.off("movestart", n, this), n = null }; this._map.on("movestart", n, this), this._map.on("moveend", i, this), this.on("animationend", i, this), e.__parent.zoomToBounds(), n && i.call(this) } }, onAdd: function (e) { this._map = e; var t, i, n; if (!isFinite(this._map.getMaxZoom())) throw "Map has no maxZoom specified"; for (this._featureGroup.addTo(e), this._nonPointGroup.addTo(e), this._gridClusters || this._generateInitialClusters(), this._maxLat = e.options.crs.projection.MAX_LATITUDE, t = 0, i = this._needsRemoving.length; i > t; t++) n = this._needsRemoving[t], this._removeLayer(n, !0); this._needsRemoving = [], this._zoom = Math.round(this._map._zoom), this._currentShownBounds = this._getExpandedVisibleBounds(), this._map.on("zoomend", this._zoomEnd, this), this._map.on("moveend", this._moveEnd, this), this._spiderfierOnAdd && this._spiderfierOnAdd(), this._bindEvents(), i = this._needsClustering, this._needsClustering = [], this.addLayers(i) }, onRemove: function (e) { e.off("zoomend", this._zoomEnd, this), e.off("moveend", this._moveEnd, this), this._unbindEvents(), this._map._mapPane.className = this._map._mapPane.className.replace(" leaflet-cluster-anim", ""), this._spiderfierOnRemove && this._spiderfierOnRemove(), delete this._maxLat, this._hideCoverage(), this._featureGroup.remove(), this._nonPointGroup.remove(), this._featureGroup.clearLayers(), this._map = null }, getVisibleParent: function (e) { for (var t = e; t && !t._icon;) t = t.__parent; return t || null }, _arraySplice: function (e, t) { for (var i = e.length - 1; i >= 0; i--) if (e[i] === t) return e.splice(i, 1), !0 }, _removeFromGridUnclustered: function (e, t) { for (var i = this._map, n = this._gridUnclustered; t >= 0 && n[t].removeObject(e, i.project(e.getLatLng(), t)) ; t--); }, _childMarkerMoved: function (e) { this._ignoreMove || (e.target._latlng = e.oldLatLng, this.removeLayer(e.target), e.target._latlng = e.latlng, this.addLayer(e.target)) }, _removeLayer: function (e, t, i) { var n = this._gridClusters, s = this._gridUnclustered, r = this._featureGroup, o = this._map; t && this._removeFromGridUnclustered(e, this._maxZoom); var a, h = e.__parent, u = h._markers; for (this._arraySplice(u, e) ; h && (h._childCount--, h._boundsNeedUpdate = !0, !(h._zoom < 0)) ;) t && h._childCount <= 1 ? (a = h._markers[0] === e ? h._markers[1] : h._markers[0], n[h._zoom].removeObject(h, o.project(h._cLatLng, h._zoom)), s[h._zoom].addObject(a, o.project(a.getLatLng(), h._zoom)), this._arraySplice(h.__parent._childClusters, h), h.__parent._markers.push(a), a.__parent = h.__parent, h._icon && (r.removeLayer(h), i || r.addLayer(a))) : h._iconNeedsUpdate = !0, h = h.__parent; delete e.__parent }, _isOrIsParent: function (e, t) { for (; t;) { if (e === t) return !0; t = t.parentNode } return !1 }, fire: function (e, t, i) { if (t && t.layer instanceof L.MarkerCluster) { if (t.originalEvent && this._isOrIsParent(t.layer._icon, t.originalEvent.relatedTarget)) return; e = "cluster" + e } L.FeatureGroup.prototype.fire.call(this, e, t, i) }, listens: function (e, t) { return L.FeatureGroup.prototype.listens.call(this, e, t) || L.FeatureGroup.prototype.listens.call(this, "cluster" + e, t) }, _defaultIconCreateFunction: function (e) { var t = e.getChildCount(), i = " marker-cluster-"; return i += 10 > t ? "small" : 100 > t ? "medium" : "large", new L.DivIcon({ html: "<div><span>" + t + "</span></div>", className: "marker-cluster" + i, iconSize: new L.Point(40, 40) }) }, _bindEvents: function () { var e = this._map, t = this.options.spiderfyOnMaxZoom, i = this.options.showCoverageOnHover, n = this.options.zoomToBoundsOnClick; (t || n) && this.on("clusterclick", this._zoomOrSpiderfy, this), i && (this.on("clustermouseover", this._showCoverage, this), this.on("clustermouseout", this._hideCoverage, this), e.on("zoomend", this._hideCoverage, this)) }, _zoomOrSpiderfy: function (e) { for (var t = e.layer, i = t; 1 === i._childClusters.length;) i = i._childClusters[0]; i._zoom === this._maxZoom && i._childCount === t._childCount && this.options.spiderfyOnMaxZoom ? t.spiderfy() : this.options.zoomToBoundsOnClick && t.zoomToBounds(), e.originalEvent && 13 === e.originalEvent.keyCode && this._map._container.focus() }, _showCoverage: function (e) { var t = this._map; this._inZoomAnimation || (this._shownPolygon && t.removeLayer(this._shownPolygon), e.layer.getChildCount() > 2 && e.layer !== this._spiderfied && (this._shownPolygon = new L.Polygon(e.layer.getConvexHull(), this.options.polygonOptions), t.addLayer(this._shownPolygon))) }, _hideCoverage: function () { this._shownPolygon && (this._map.removeLayer(this._shownPolygon), this._shownPolygon = null) }, _unbindEvents: function () { var e = this.options.spiderfyOnMaxZoom, t = this.options.showCoverageOnHover, i = this.options.zoomToBoundsOnClick, n = this._map; (e || i) && this.off("clusterclick", this._zoomOrSpiderfy, this), t && (this.off("clustermouseover", this._showCoverage, this), this.off("clustermouseout", this._hideCoverage, this), n.off("zoomend", this._hideCoverage, this)) }, _zoomEnd: function () { this._map && (this._mergeSplitClusters(), this._zoom = Math.round(this._map._zoom), this._currentShownBounds = this._getExpandedVisibleBounds()) }, _moveEnd: function () { if (!this._inZoomAnimation) { var e = this._getExpandedVisibleBounds(); this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds, this._zoom, e), this._topClusterLevel._recursivelyAddChildrenToMap(null, Math.round(this._map._zoom), e), this._currentShownBounds = e } }, _generateInitialClusters: function () { var e = this._map.getMaxZoom(), t = this.options.maxClusterRadius, i = t; "function" != typeof t && (i = function () { return t }), this.options.disableClusteringAtZoom && (e = this.options.disableClusteringAtZoom - 1), this._maxZoom = e, this._gridClusters = {}, this._gridUnclustered = {}; for (var n = e; n >= 0; n--) this._gridClusters[n] = new L.DistanceGrid(i(n)), this._gridUnclustered[n] = new L.DistanceGrid(i(n)); this._topClusterLevel = new this._markerCluster(this, -1) }, _addLayer: function (e, t) { var i, n, s = this._gridClusters, r = this._gridUnclustered; for (this.options.singleMarkerMode && this._overrideMarkerIcon(e), e.on("move", this._childMarkerMoved, this) ; t >= 0; t--) { i = this._map.project(e.getLatLng(), t); var o = s[t].getNearObject(i); if (o) return o._addChild(e), e.__parent = o, void 0; if (o = r[t].getNearObject(i)) { var a = o.__parent; a && this._removeLayer(o, !1); var h = new this._markerCluster(this, t, o, e); s[t].addObject(h, this._map.project(h._cLatLng, t)), o.__parent = h, e.__parent = h; var u = h; for (n = t - 1; n > a._zoom; n--) u = new this._markerCluster(this, n, u), s[n].addObject(u, this._map.project(o.getLatLng(), n)); return a._addChild(u), this._removeFromGridUnclustered(o, t), void 0 } r[t].addObject(e, i) } this._topClusterLevel._addChild(e), e.__parent = this._topClusterLevel }, _refreshClustersIcons: function () { this._featureGroup.eachLayer(function (e) { e instanceof L.MarkerCluster && e._iconNeedsUpdate && e._updateIcon() }) }, _enqueue: function (e) { this._queue.push(e), this._queueTimeout || (this._queueTimeout = setTimeout(L.bind(this._processQueue, this), 300)) }, _processQueue: function () { for (var e = 0; e < this._queue.length; e++) this._queue[e].call(this); this._queue.length = 0, clearTimeout(this._queueTimeout), this._queueTimeout = null }, _mergeSplitClusters: function () { var e = Math.round(this._map._zoom); this._processQueue(), this._zoom < e && this._currentShownBounds.intersects(this._getExpandedVisibleBounds()) ? (this._animationStart(), this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds, this._zoom, this._getExpandedVisibleBounds()), this._animationZoomIn(this._zoom, e)) : this._zoom > e ? (this._animationStart(), this._animationZoomOut(this._zoom, e)) : this._moveEnd() }, _getExpandedVisibleBounds: function () { return this.options.removeOutsideVisibleBounds ? L.Browser.mobile ? this._checkBoundsMaxLat(this._map.getBounds()) : this._checkBoundsMaxLat(this._map.getBounds().pad(1)) : this._mapBoundsInfinite }, _checkBoundsMaxLat: function (e) { var t = this._maxLat; return t !== i && (e.getNorth() >= t && (e._northEast.lat = 1 / 0), e.getSouth() <= -t && (e._southWest.lat = -1 / 0)), e }, _animationAddLayerNonAnimated: function (e, t) { if (t === e) this._featureGroup.addLayer(e); else if (2 === t._childCount) { t._addToMap(); var i = t.getAllChildMarkers(); this._featureGroup.removeLayer(i[0]), this._featureGroup.removeLayer(i[1]) } else t._updateIcon() }, _extractNonGroupLayers: function (e, t) { var i, n = e.getLayers(), s = 0; for (t = t || []; s < n.length; s++) i = n[s], i instanceof L.LayerGroup ? this._extractNonGroupLayers(i, t) : t.push(i); return t }, _overrideMarkerIcon: function (e) { var t = e.options.icon = this.options.iconCreateFunction({ getChildCount: function () { return 1 }, getAllChildMarkers: function () { return [e] } }); return t } }), L.MarkerClusterGroup.include({ _mapBoundsInfinite: new L.LatLngBounds(new L.LatLng(-1 / 0, -1 / 0), new L.LatLng(1 / 0, 1 / 0)) }), L.MarkerClusterGroup.include({ _noAnimation: { _animationStart: function () { }, _animationZoomIn: function (e, t) { this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds, e), this._topClusterLevel._recursivelyAddChildrenToMap(null, t, this._getExpandedVisibleBounds()), this.fire("animationend") }, _animationZoomOut: function (e, t) { this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds, e), this._topClusterLevel._recursivelyAddChildrenToMap(null, t, this._getExpandedVisibleBounds()), this.fire("animationend") }, _animationAddLayer: function (e, t) { this._animationAddLayerNonAnimated(e, t) } }, _withAnimation: { _animationStart: function () { this._map._mapPane.className += " leaflet-cluster-anim", this._inZoomAnimation++ }, _animationZoomIn: function (e, t) { var i, n = this._getExpandedVisibleBounds(), s = this._featureGroup; this._ignoreMove = !0, this._topClusterLevel._recursively(n, e, 0, function (r) { var o, a = r._latlng, h = r._markers; for (n.contains(a) || (a = null), r._isSingleParent() && e + 1 === t ? (s.removeLayer(r), r._recursivelyAddChildrenToMap(null, t, n)) : (r.clusterHide(), r._recursivelyAddChildrenToMap(a, t, n)), i = h.length - 1; i >= 0; i--) o = h[i], n.contains(o._latlng) || s.removeLayer(o) }), this._forceLayout(), this._topClusterLevel._recursivelyBecomeVisible(n, t), s.eachLayer(function (e) { e instanceof L.MarkerCluster || !e._icon || e.clusterShow() }), this._topClusterLevel._recursively(n, e, t, function (e) { e._recursivelyRestoreChildPositions(t) }), this._ignoreMove = !1, this._enqueue(function () { this._topClusterLevel._recursively(n, e, 0, function (e) { s.removeLayer(e), e.clusterShow() }), this._animationEnd() }) }, _animationZoomOut: function (e, t) { this._animationZoomOutSingle(this._topClusterLevel, e - 1, t), this._topClusterLevel._recursivelyAddChildrenToMap(null, t, this._getExpandedVisibleBounds()), this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds, e, this._getExpandedVisibleBounds()) }, _animationAddLayer: function (e, t) { var i = this, n = this._featureGroup; n.addLayer(e), t !== e && (t._childCount > 2 ? (t._updateIcon(), this._forceLayout(), this._animationStart(), e._setPos(this._map.latLngToLayerPoint(t.getLatLng())), e.clusterHide(), this._enqueue(function () { n.removeLayer(e), e.clusterShow(), i._animationEnd() })) : (this._forceLayout(), i._animationStart(), i._animationZoomOutSingle(t, this._map.getMaxZoom(), this._zoom))) } }, _animationZoomOutSingle: function (e, t, i) { var n = this._getExpandedVisibleBounds(); e._recursivelyAnimateChildrenInAndAddSelfToMap(n, t + 1, i); var s = this; this._forceLayout(), e._recursivelyBecomeVisible(n, i), this._enqueue(function () { if (1 === e._childCount) { var r = e._markers[0]; this._ignoreMove = !0, r.setLatLng(r.getLatLng()), this._ignoreMove = !1, r.clusterShow && r.clusterShow() } else e._recursively(n, i, 0, function (e) { e._recursivelyRemoveChildrenFromMap(n, t + 1) }); s._animationEnd() }) }, _animationEnd: function () { this._map && (this._map._mapPane.className = this._map._mapPane.className.replace(" leaflet-cluster-anim", "")), this._inZoomAnimation--, this.fire("animationend") }, _forceLayout: function () { L.Util.falseFn(t.body.offsetWidth) } }), L.markerClusterGroup = function (e) { return new L.MarkerClusterGroup(e) }, L.MarkerCluster = L.Marker.extend({ initialize: function (e, t, i, n) { L.Marker.prototype.initialize.call(this, i ? i._cLatLng || i.getLatLng() : new L.LatLng(0, 0), { icon: this }), this._group = e, this._zoom = t, this._markers = [], this._childClusters = [], this._childCount = 0, this._iconNeedsUpdate = !0, this._boundsNeedUpdate = !0, this._bounds = new L.LatLngBounds, i && this._addChild(i), n && this._addChild(n) }, getAllChildMarkers: function (e) { e = e || []; for (var t = this._childClusters.length - 1; t >= 0; t--) this._childClusters[t].getAllChildMarkers(e); for (var i = this._markers.length - 1; i >= 0; i--) e.push(this._markers[i]); return e }, getChildCount: function () { return this._childCount }, zoomToBounds: function () { for (var e, t = this._childClusters.slice(), i = this._group._map, n = i.getBoundsZoom(this._bounds), s = this._zoom + 1, r = i.getZoom() ; t.length > 0 && n > s;) { s++; var o = []; for (e = 0; e < t.length; e++) o = o.concat(t[e]._childClusters); t = o } n > s ? this._group._map.setView(this._latlng, s) : r >= n ? this._group._map.setView(this._latlng, r + 1) : this._group._map.fitBounds(this._bounds) }, getBounds: function () { var e = new L.LatLngBounds; return e.extend(this._bounds), e }, _updateIcon: function () { this._iconNeedsUpdate = !0, this._icon && this.setIcon(this) }, createIcon: function () { return this._iconNeedsUpdate && (this._iconObj = this._group.options.iconCreateFunction(this), this._iconNeedsUpdate = !1), this._iconObj.createIcon() }, createShadow: function () { return this._iconObj.createShadow() }, _addChild: function (e, t) { this._iconNeedsUpdate = !0, this._boundsNeedUpdate = !0, this._setClusterCenter(e), e instanceof L.MarkerCluster ? (t || (this._childClusters.push(e), e.__parent = this), this._childCount += e._childCount) : (t || this._markers.push(e), this._childCount++), this.__parent && this.__parent._addChild(e, !0) }, _setClusterCenter: function (e) { this._cLatLng || (this._cLatLng = e._cLatLng || e._latlng) }, _resetBounds: function () { var e = this._bounds; e._southWest && (e._southWest.lat = 1 / 0, e._southWest.lng = 1 / 0), e._northEast && (e._northEast.lat = -1 / 0, e._northEast.lng = -1 / 0) }, _recalculateBounds: function () { var e, t, i, n, s = this._markers, r = this._childClusters, o = 0, a = 0, h = this._childCount; if (0 !== h) { for (this._resetBounds(), e = 0; e < s.length; e++) i = s[e]._latlng, this._bounds.extend(i), o += i.lat, a += i.lng; for (e = 0; e < r.length; e++) t = r[e], t._boundsNeedUpdate && t._recalculateBounds(), this._bounds.extend(t._bounds), i = t._wLatLng, n = t._childCount, o += i.lat * n, a += i.lng * n; this._latlng = this._wLatLng = new L.LatLng(o / h, a / h), this._boundsNeedUpdate = !1 } }, _addToMap: function (e) { e && (this._backupLatlng = this._latlng, this.setLatLng(e)), this._group._featureGroup.addLayer(this) }, _recursivelyAnimateChildrenIn: function (e, t, i) { this._recursively(e, 0, i - 1, function (e) { var i, n, s = e._markers; for (i = s.length - 1; i >= 0; i--) n = s[i], n._icon && (n._setPos(t), n.clusterHide()) }, function (e) { var i, n, s = e._childClusters; for (i = s.length - 1; i >= 0; i--) n = s[i], n._icon && (n._setPos(t), n.clusterHide()) }) }, _recursivelyAnimateChildrenInAndAddSelfToMap: function (e, t, i) { this._recursively(e, i, 0, function (n) { n._recursivelyAnimateChildrenIn(e, n._group._map.latLngToLayerPoint(n.getLatLng()).round(), t), n._isSingleParent() && t - 1 === i ? (n.clusterShow(), n._recursivelyRemoveChildrenFromMap(e, t)) : n.clusterHide(), n._addToMap() }) }, _recursivelyBecomeVisible: function (e, t) { this._recursively(e, 0, t, null, function (e) { e.clusterShow() }) }, _recursivelyAddChildrenToMap: function (e, t, i) { this._recursively(i, -1, t, function (n) { if (t !== n._zoom) for (var s = n._markers.length - 1; s >= 0; s--) { var r = n._markers[s]; i.contains(r._latlng) && (e && (r._backupLatlng = r.getLatLng(), r.setLatLng(e), r.clusterHide && r.clusterHide()), n._group._featureGroup.addLayer(r)) } }, function (t) { t._addToMap(e) }) }, _recursivelyRestoreChildPositions: function (e) { for (var t = this._markers.length - 1; t >= 0; t--) { var i = this._markers[t]; i._backupLatlng && (i.setLatLng(i._backupLatlng), delete i._backupLatlng) } if (e - 1 === this._zoom) for (var n = this._childClusters.length - 1; n >= 0; n--) this._childClusters[n]._restorePosition(); else for (var s = this._childClusters.length - 1; s >= 0; s--) this._childClusters[s]._recursivelyRestoreChildPositions(e) }, _restorePosition: function () { this._backupLatlng && (this.setLatLng(this._backupLatlng), delete this._backupLatlng) }, _recursivelyRemoveChildrenFromMap: function (e, t, i) { var n, s; this._recursively(e, -1, t - 1, function (e) { for (s = e._markers.length - 1; s >= 0; s--) n = e._markers[s], i && i.contains(n._latlng) || (e._group._featureGroup.removeLayer(n), n.clusterShow && n.clusterShow()) }, function (e) { for (s = e._childClusters.length - 1; s >= 0; s--) n = e._childClusters[s], i && i.contains(n._latlng) || (e._group._featureGroup.removeLayer(n), n.clusterShow && n.clusterShow()) }) }, _recursively: function (e, t, i, n, s) { var r, o, a = this._childClusters, h = this._zoom; if (h >= t && (n && n(this), s && h === i && s(this)), t > h || i > h) for (r = a.length - 1; r >= 0; r--) o = a[r], e.intersects(o._bounds) && o._recursively(e, t, i, n, s) }, _isSingleParent: function () { return this._childClusters.length > 0 && this._childClusters[0]._childCount === this._childCount } }), L.Marker.include({ clusterHide: function () { return this.options.opacityWhenUnclustered = this.options.opacity || 1, this.setOpacity(0) }, clusterShow: function () { var e = this.setOpacity(this.options.opacity || this.options.opacityWhenUnclustered); return delete this.options.opacityWhenUnclustered, e } }), L.DistanceGrid = function (e) { this._cellSize = e, this._sqCellSize = e * e, this._grid = {}, this._objectPoint = {} }, L.DistanceGrid.prototype = { addObject: function (e, t) { var i = this._getCoord(t.x), n = this._getCoord(t.y), s = this._grid, r = s[n] = s[n] || {}, o = r[i] = r[i] || [], a = L.Util.stamp(e); this._objectPoint[a] = t, o.push(e) }, updateObject: function (e, t) { this.removeObject(e), this.addObject(e, t) }, removeObject: function (e, t) { var i, n, s = this._getCoord(t.x), r = this._getCoord(t.y), o = this._grid, a = o[r] = o[r] || {}, h = a[s] = a[s] || []; for (delete this._objectPoint[L.Util.stamp(e)], i = 0, n = h.length; n > i; i++) if (h[i] === e) return h.splice(i, 1), 1 === n && delete a[s], !0 }, eachObject: function (e, t) { var i, n, s, r, o, a, h, u = this._grid; for (i in u) { o = u[i]; for (n in o) for (a = o[n], s = 0, r = a.length; r > s; s++) h = e.call(t, a[s]), h && (s--, r--) } }, getNearObject: function (e) { var t, i, n, s, r, o, a, h, u = this._getCoord(e.x), l = this._getCoord(e.y), _ = this._objectPoint, d = this._sqCellSize, c = null; for (t = l - 1; l + 1 >= t; t++) if (s = this._grid[t]) for (i = u - 1; u + 1 >= i; i++) if (r = s[i]) for (n = 0, o = r.length; o > n; n++) a = r[n], h = this._sqDist(_[L.Util.stamp(a)], e), d > h && (d = h, c = a); return c }, _getCoord: function (e) { return Math.floor(e / this._cellSize) }, _sqDist: function (e, t) { var i = t.x - e.x, n = t.y - e.y; return i * i + n * n } }, function () { L.QuickHull = { getDistant: function (e, t) { var i = t[1].lat - t[0].lat, n = t[0].lng - t[1].lng; return n * (e.lat - t[0].lat) + i * (e.lng - t[0].lng) }, findMostDistantPointFromBaseLine: function (e, t) { var i, n, s, r = 0, o = null, a = []; for (i = t.length - 1; i >= 0; i--) n = t[i], s = this.getDistant(n, e), s > 0 && (a.push(n), s > r && (r = s, o = n)); return { maxPoint: o, newPoints: a } }, buildConvexHull: function (e, t) { var i = [], n = this.findMostDistantPointFromBaseLine(e, t); return n.maxPoint ? (i = i.concat(this.buildConvexHull([e[0], n.maxPoint], n.newPoints)), i = i.concat(this.buildConvexHull([n.maxPoint, e[1]], n.newPoints))) : [e[0]] }, getConvexHull: function (e) { var t, i = !1, n = !1, s = !1, r = !1, o = null, a = null, h = null, u = null, l = null, _ = null; for (t = e.length - 1; t >= 0; t--) { var d = e[t]; (i === !1 || d.lat > i) && (o = d, i = d.lat), (n === !1 || d.lat < n) && (a = d, n = d.lat), (s === !1 || d.lng > s) && (h = d, s = d.lng), (r === !1 || d.lng < r) && (u = d, r = d.lng) } n !== i ? (_ = a, l = o) : (_ = u, l = h); var c = [].concat(this.buildConvexHull([_, l], e), this.buildConvexHull([l, _], e)); return c } } }(), L.MarkerCluster.include({ getConvexHull: function () { var e, t, i = this.getAllChildMarkers(), n = []; for (t = i.length - 1; t >= 0; t--) e = i[t].getLatLng(), n.push(e); return L.QuickHull.getConvexHull(n) } }), L.MarkerCluster.include({ _2PI: 2 * Math.PI, _circleFootSeparation: 25, _circleStartAngle: Math.PI / 6, _spiralFootSeparation: 28, _spiralLengthStart: 11, _spiralLengthFactor: 5, _circleSpiralSwitchover: 9, spiderfy: function () { if (this._group._spiderfied !== this && !this._group._inZoomAnimation) { var e, t = this.getAllChildMarkers(), i = this._group, n = i._map, s = n.latLngToLayerPoint(this._latlng); this._group._unspiderfy(), this._group._spiderfied = this, t.length >= this._circleSpiralSwitchover ? e = this._generatePointsSpiral(t.length, s) : (s.y += 10, e = this._generatePointsCircle(t.length, s)), this._animationSpiderfy(t, e) } }, unspiderfy: function (e) { this._group._inZoomAnimation || (this._animationUnspiderfy(e), this._group._spiderfied = null) }, _generatePointsCircle: function (e, t) { var i, n, s = this._group.options.spiderfyDistanceMultiplier * this._circleFootSeparation * (2 + e), r = s / this._2PI, o = this._2PI / e, a = []; for (a.length = e, i = e - 1; i >= 0; i--) n = this._circleStartAngle + i * o, a[i] = new L.Point(t.x + r * Math.cos(n), t.y + r * Math.sin(n))._round(); return a }, _generatePointsSpiral: function (e, t) { var i, n = this._group.options.spiderfyDistanceMultiplier, s = n * this._spiralLengthStart, r = n * this._spiralFootSeparation, o = n * this._spiralLengthFactor * this._2PI, a = 0, h = []; for (h.length = e, i = e - 1; i >= 0; i--) a += r / s + 5e-4 * i, h[i] = new L.Point(t.x + s * Math.cos(a), t.y + s * Math.sin(a))._round(), s += o / a; return h }, _noanimationUnspiderfy: function () { var e, t, i = this._group, n = i._map, s = i._featureGroup, r = this.getAllChildMarkers(); for (i._ignoreMove = !0, this.setOpacity(1), t = r.length - 1; t >= 0; t--) e = r[t], s.removeLayer(e), e._preSpiderfyLatlng && (e.setLatLng(e._preSpiderfyLatlng), delete e._preSpiderfyLatlng), e.setZIndexOffset && e.setZIndexOffset(0), e._spiderLeg && (n.removeLayer(e._spiderLeg), delete e._spiderLeg); i.fire("unspiderfied", { cluster: this, markers: r }), i._ignoreMove = !1, i._spiderfied = null } }), L.MarkerClusterNonAnimated = L.MarkerCluster.extend({ _animationSpiderfy: function (e, t) { var i, n, s, r, o = this._group, a = o._map, h = o._featureGroup, u = this._group.options.spiderLegPolylineOptions; for (o._ignoreMove = !0, i = 0; i < e.length; i++) r = a.layerPointToLatLng(t[i]), n = e[i], s = new L.Polyline([this._latlng, r], u), a.addLayer(s), n._spiderLeg = s, n._preSpiderfyLatlng = n._latlng, n.setLatLng(r), n.setZIndexOffset && n.setZIndexOffset(1e6), h.addLayer(n); this.setOpacity(.3), o._ignoreMove = !1, o.fire("spiderfied", { cluster: this, markers: e }) }, _animationUnspiderfy: function () { this._noanimationUnspiderfy() } }), L.MarkerCluster.include({ _animationSpiderfy: function (e, t) { var n, s, r, o, a, h, u = this, l = this._group, _ = l._map, d = l._featureGroup, c = this._latlng, p = _.latLngToLayerPoint(c), f = L.Path.SVG, m = L.extend({}, this._group.options.spiderLegPolylineOptions), g = m.opacity; for (g === i && (g = L.MarkerClusterGroup.prototype.options.spiderLegPolylineOptions.opacity), f ? (m.opacity = 0, m.className = (m.className || "") + " leaflet-cluster-spider-leg") : m.opacity = g, l._ignoreMove = !0, n = 0; n < e.length; n++) s = e[n], h = _.layerPointToLatLng(t[n]), r = new L.Polyline([c, h], m), _.addLayer(r), s._spiderLeg = r, f && (o = r._path, a = o.getTotalLength() + .1, o.style.strokeDasharray = a, o.style.strokeDashoffset = a), s.setZIndexOffset && s.setZIndexOffset(1e6), s.clusterHide && s.clusterHide(), d.addLayer(s), s._setPos && s._setPos(p); for (l._forceLayout(), l._animationStart(), n = e.length - 1; n >= 0; n--) h = _.layerPointToLatLng(t[n]), s = e[n], s._preSpiderfyLatlng = s._latlng, s.setLatLng(h), s.clusterShow && s.clusterShow(), f && (r = s._spiderLeg, o = r._path, o.style.strokeDashoffset = 0, r.setStyle({ opacity: g })); this.setOpacity(.3), l._ignoreMove = !1, setTimeout(function () { l._animationEnd(), l.fire("spiderfied", { cluster: u, markers: e }) }, 200) }, _animationUnspiderfy: function (e) { var t, i, n, s, r, o, a = this, h = this._group, u = h._map, l = h._featureGroup, _ = e ? u._latLngToNewLayerPoint(this._latlng, e.zoom, e.center) : u.latLngToLayerPoint(this._latlng), d = this.getAllChildMarkers(), c = L.Path.SVG; for (h._ignoreMove = !0, h._animationStart(), this.setOpacity(1), i = d.length - 1; i >= 0; i--) t = d[i], t._preSpiderfyLatlng && (t.setLatLng(t._preSpiderfyLatlng), delete t._preSpiderfyLatlng, o = !0, t._setPos && (t._setPos(_), o = !1), t.clusterHide && (t.clusterHide(), o = !1), o && l.removeLayer(t), c && (n = t._spiderLeg, s = n._path, r = s.getTotalLength() + .1, s.style.strokeDashoffset = r, n.setStyle({ opacity: 0 }))); h._ignoreMove = !1, setTimeout(function () { var e = 0; for (i = d.length - 1; i >= 0; i--) t = d[i], t._spiderLeg && e++; for (i = d.length - 1; i >= 0; i--) t = d[i], t._spiderLeg && (t.clusterShow && t.clusterShow(), t.setZIndexOffset && t.setZIndexOffset(0), e > 1 && l.removeLayer(t), u.removeLayer(t._spiderLeg), delete t._spiderLeg); h._animationEnd(), h.fire("unspiderfied", { cluster: a, markers: d }) }, 200) } }), L.MarkerClusterGroup.include({ _spiderfied: null, unspiderfy: function () { this._unspiderfy.apply(this, arguments) }, _spiderfierOnAdd: function () { this._map.on("click", this._unspiderfyWrapper, this), this._map.options.zoomAnimation && this._map.on("zoomstart", this._unspiderfyZoomStart, this), this._map.on("zoomend", this._noanimationUnspiderfy, this), L.Browser.touch || this._map.getRenderer(this) }, _spiderfierOnRemove: function () { this._map.off("click", this._unspiderfyWrapper, this), this._map.off("zoomstart", this._unspiderfyZoomStart, this), this._map.off("zoomanim", this._unspiderfyZoomAnim, this), this._map.off("zoomend", this._noanimationUnspiderfy, this), this._noanimationUnspiderfy() }, _unspiderfyZoomStart: function () { this._map && this._map.on("zoomanim", this._unspiderfyZoomAnim, this) }, _unspiderfyZoomAnim: function (e) { L.DomUtil.hasClass(this._map._mapPane, "leaflet-touching") || (this._map.off("zoomanim", this._unspiderfyZoomAnim, this), this._unspiderfy(e)) }, _unspiderfyWrapper: function () { this._unspiderfy() }, _unspiderfy: function (e) { this._spiderfied && this._spiderfied.unspiderfy(e) }, _noanimationUnspiderfy: function () { this._spiderfied && this._spiderfied._noanimationUnspiderfy() }, _unspiderfyLayer: function (e) { e._spiderLeg && (this._featureGroup.removeLayer(e), e.clusterShow && e.clusterShow(), e.setZIndexOffset && e.setZIndexOffset(0), this._map.removeLayer(e._spiderLeg), delete e._spiderLeg) } }), L.MarkerClusterGroup.include({ refreshClusters: function (e) { return e ? e instanceof L.MarkerClusterGroup ? e = e._topClusterLevel.getAllChildMarkers() : e instanceof L.LayerGroup ? e = e._layers : e instanceof L.MarkerCluster ? e = e.getAllChildMarkers() : e instanceof L.Marker && (e = [e]) : e = this._topClusterLevel.getAllChildMarkers(), this._flagParentsIconsNeedUpdate(e), this._refreshClustersIcons(), this.options.singleMarkerMode && this._refreshSingleMarkerModeMarkers(e), this }, _flagParentsIconsNeedUpdate: function (e) { var t, i; for (t in e) for (i = e[t].__parent; i;) i._iconNeedsUpdate = !0, i = i.__parent }, _refreshSingleMarkerModeMarkers: function (e) { var t, i; for (t in e) i = e[t], this.hasLayer(i) && i.setIcon(this._overrideMarkerIcon(i)) } }), L.Marker.include({ refreshIconOptions: function (e, t) { var i = this.options.icon; return L.setOptions(i, e), this.setIcon(i), t && this.__parent && this.__parent._group.refreshClusters(this), this } }) }(window, document);

</script>

<link href="fip.css" rel="stylesheet" />

<div class="content">
    <div class="container">
        <div class="row">

            <div class="col-sm-12">
                <p class="map_pretext1">
					The Formerly Incarcerated Persons Map (FIP's) is a connection point for FIP programs for each state.  The primary focus of these programs is to remove or reduce barriers to successful reentry, so that motivated individuals - who have served their time and paid their debt to society - are able to compete for a job, attain housing, support their children and their families, and contribute to their communities. 
                </p>
            </div>

			<form id="multiSelectGroup">
            <div class="col-sm-3">
                <div class="panel-group">
                    <!--<div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                <a data-toggle="collapse">Target Group</a>
                            </h3>
                        </div>
                        <div id="program_collapse" class="panel-collapse collapse in">
                            <div class="panel-body">
                                <div id="program_div">
                                    <select id="program_select" name="program_select" multiple="multiple">
										<option value="African Americans">African Americans</option>
										<option value="Asian Americans">Asian Americans</option>
										<option value="Disabled Persons">Disabled Persons</option>
										<option value="Formerly Incarcerated Persons">Formerly Incarcerated Persons</option>
										<option value="General">General</option>
										<option value="Hispanic Americans">Hispanic Americans</option>
										<option value="Tribal/Native Americans">Tribal/Native Americans</option>
										<option value="Veterans">Veterans</option>
										<option value="Women">Women</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>-->
                </div>
				</form>

                <div class="panel-group">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                <a data-toggle="collapse">State</a>
                            </h3>
                        </div>
                        <div id="state_collapse" class="panel-collapse collapse in">
                            <div class="panel-body">
								<div id="state_div">
									<select id="state_select" name="state_select" multiple="multiple">
										<option value="AL">Alabama</option>
										<option value="AK">Alaska</option>
										<option value="AS">American Samoa</option>
										<option value="AZ">Arizona</option>
										<option value="AR">Arkansas</option>
										<option value="CA">California</option>
										<option value="CO">Colorado</option>
										<option value="CT">Connecticut</option>
										<option value="DE">Delaware</option>
										<option value="DC">District Of Columbia</option>
										<option value="FL">Florida</option>
										<option value="GA">Georgia</option>
										<option value="GU">Guam</option>
										<option value="HI">Hawaii</option>
										<option value="ID">Idaho</option>
										<option value="IL">Illinois</option>
										<option value="IN">Indiana</option>
										<option value="IA">Iowa</option>
										<option value="KS">Kansas</option>
										<option value="KY">Kentucky</option>
										<option value="LA">Louisiana</option>
										<option value="ME">Maine</option>
										<option value="MD">Maryland</option>
										<option value="MA">Massachusetts</option>
										<option value="MI">Michigan</option>
										<option value="MN">Minnesota</option>
										<option value="MS">Mississippi</option>
										<option value="MO">Missouri</option>
										<option value="MT">Montana</option>
										<option value="NE">Nebraska</option>
										<option value="NV">Nevada</option>
										<option value="NH">New Hampshire</option>
										<option value="NJ">New Jersey</option>
										<option value="NM">New Mexico</option>
										<option value="NY">New York</option>
										<option value="NC">North Carolina</option>
										<option value="ND">North Dakota</option>
										<option value="MP">Northern Mariana Islands</option>
										<option value="OH">Ohio</option>
										<option value="OK">Oklahoma</option>
										<option value="OR">Oregon</option>
										<option value="PA">Pennsylvania</option>
										<option value="PR">Puerto Rico</option>
										<option value="RI">Rhode Island</option>
										<option value="SC">South Carolina</option>
										<option value="SD">South Dakota</option>
										<option value="TN">Tennessee</option>
										<option value="TX">Texas</option>
										<option value="VI">U.S. Virgin Islands</option>
										<option value="UT">Utah</option>
										<option value="VT">Vermont</option>
										<option value="VA">Virginia</option>
										<option value="WA">Washington</option>
										<option value="WV">West Virginia</option>
										<option value="WI">Wisconsin</option>
										<option value="WY">Wyoming</option>
									</select>
								</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <div class="panel-group">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                <a data-toggle="collapse">Status</a>
                            </h3>
                        </div>
                        <div id="status_collapse" class="panel-collapse collapse in">
                            <div class="panel-body">
                                <div id="status_div">
									<select id="status_select" name="status_select" multiple="multiple">
										<option value="Rent">Rent</option>
										<option value="Own">Own</option>
									</select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->

                <div class="panel-group panel-default" style="display: none;">
                    <div id="reset_collapse" class="panel-collapse collapse in">
                        <button id="btnReset" type="button" class="btn btn-default">Reset</button>
                    </div>
                </div>
            </div>

            <div class="col-sm-9">
                <div class="panel panel-default">
                    <div id="map"></div>
                    <div id='map-overlay-alaska'></div>
                    <div id='map-overlay-hawaii'></div>
                </div>
            </div>
            <br />
            <div class="col-sm-12" id="dt_container">
                <table id="projects-datatable" class="display dataTable"></table>
            </div>
        </div>
    </div>
</div>

<script>

$(document).ready(function () {

	//setup Column locations
	var objColumn = {
		"Program_Links": 2,
//		"Recipient_Type": 6,
//		"Award_Type": 7,
		"State": 7,
//		"Status": 6,
	};

	/* Formatting function for row details - modify as you need */
	function format(d) {
	
		var Year_Awarded_Text = '';
		switch(d.Award_Type.trim()) {
			case 'Annual Operating Plan':
				Year_Awarded_Text = 'Fiscal Years';
				break;
			case 'Competitive Funding Opportunity Announcement':
			case 'Other':
				Year_Awarded_Text = 'Fiscal Year Awarded';
				break;
		}

		return '<h5>Project Description:</h5>' +
					'<p class="dt_details">' + d.Project_Description + '</p>' +
				(((d.FOA_Name != null && d.FOA_Name != '') && (d.Award_Type.trim() == 'Competitive Funding Opportunity Announcement') || (d.Award_Type.trim() == 'FOA')) ?
					'<br /><h5 class="smallField">Funding Opportunity:</h5><p class="dt_details smallField">&nbsp;&nbsp;' +
					((d.FOA_NodeID) ?
						'<a href="https://energy.gov' + d.FOA_NodeID + '" target="_blank">' + d.FOA_Name + '</a></p><br />' : d.FOA_Name + '</p><br />') : '') +
				((d.Fiscal_Year_Awarded) ?
					'<br /><h5 class="smallField">'+Year_Awarded_Text+':</h5><p class="dt_details smallField">&nbsp;&nbsp;' + d.Fiscal_Year_Awarded + '</p><br />' : '') +
				((d.Status) ?
					'<br /><h5 class="smallField">Status:</h5><p class="dt_details smallField">&nbsp;&nbsp;' + d.Status + '</p><br />' : '') +
				((d.Award_Type.trim() == 'Annual Operating Plan')
					? '<br /><h5 class="smallField">For more information, contact <a href="mailto:' + d.Contact_email + '">' + d.Contact_email + '</a>.<br>' +
					( (d.Contact_url != null && d.Contact_url != '') ? '<br>Website: <a href="' + d.Contact_url + '" target="_blank">' + d.Contact_url + '</a></h5><br />' : '' ) 
					: '');
	}

	$(document).ready(function () {

		var csvDataFile = '20201013_fip.csv';
		$.get(csvDataFile, function (data) {

			//setup abbreviations
			var state_list = {
				'AL': "Alabama", 'AK': "Alaska", 'AS': "American Samoa",'AZ': "Arizona", 'AR': "Arkansas", 'CA': "California", 'CO': "Colorado", 'CT': "Connecticut",
				'DE': "Delaware", 'DC': "District Of Columbia", 'FL': "Florida", 'GA': "Georgia", 'GU': "Guam", 'HI': "Hawaii", 'ID': "Idaho", 'IL': "Illinois",
				'IN': "Indiana", 'IA': "Iowa", 'KS': "Kansas", 'KY': "Kentucky", 'LA': "Louisiana", 'ME': "Maine", 'MD': "Maryland",
				'MA': "Massachusetts", 'MX': "Mexico", 'MI': "Michigan", 'MN': "Minnesota", 'MS': "Mississippi", 'MO': "Missouri", 'MT': "Montana",
				'NE': "Nebraska", 'NV': "Nevada", 'NH': "New Hampshire", 'NJ': "New Jersey", 'NM': "New Mexico", 'NY': "New York", 'NC': "North Carolina", 'MP': "Northern Mariana Islands",
				'OH': "Ohio", 'OK': "Oklahoma", 'OR': "Oregon", 'PA': "Pennsylvania", 'PR': "Puerto Rico", 'ND': "North Dakota", 'RI': "Rhode Island",
				'SC': "South Carolina", 'SD': "South Dakota", 'TN': "Tennessee", 'TX': "Texas", 'UT': "Utah", 'VI': "Virgin Islands", 'VT': "Vermont",
				'VA': "Virginia", 'WA': "Washington", 'WV': "West Virginia", 'WI': "Wisconsin", 'WY': "Wyoming",  
			};

			//object to track state data points
			var stateCount = {
				'AL': 0, 'AK': 0, 'AS': 0, 'AZ': 0, 'AR': 0, 'CA': 0, 'CO': 0, 'CT': 0, 'DE': 0, 'DC': 0, 'FL': 0, 'GA': 0, 'GU': 0, 'HI': 0, 'ID': 0,
				'IL': 0, 'IN': 0, 'IA': 0, 'KS': 0, 'KY': 0, 'LA': 0, 'ME': 0, 'MD': 0, 'MA': 0, 'MX': 0, 'MI': 0, 'MN': 0, 'MS': 0,
				'MO': 0, 'MT': 0, 'NE': 0, 'NV': 0, 'NH': 0, 'NJ': 0, 'NM': 0, 'NY': 0, 'NC': 0, 'ND': 0, 'MP': 0, 'OH': 0, 'OK': 0, 'OR': 0,
				'PA': 0, 'PR': 0, 'RI': 0, 'SC': 0, 'SD': 0, 'TN': 0, 'TX': 0, 'UT': 0, 'VI': 0, 'VT': 0, 'VA': 0, 'WA': 0, 'WV': 0,
				'WI': 0, 'WY': 0, 
			};

			$.each(objJson, function (idx, obj) {
				$(obj).each(function (key, value) {
					$.each(value, function (key, value) {
						if (key == "State") {
							var arrState = value.split("; ");
							for (var i = 0; i < arrState.length; i++) {
								stateCount[arrState[i].trim()]++;
							}
						}
					});
				});
			});

			var objJson = Papa.parse((removeTrailingLine(data)), { "header": true });
			var csvJson = (JSON.stringify(objJson.data, null, 2));
			//console.log(csvJson);

			var wind_table = $('#projects-datatable').DataTable({
				"processing": true,
				"serverSide": false,
				"order": [[1, 'asc']],
				"lengthMenu": [[-1, 10, 25, 50, 100], ["All", 10, 25, 50, 100]],
				"pageLength": 50,
				"data": eval(csvJson),

				"columns": [
					{
						"class": 'details-control',
						"orderable": false,
						"data": null,
						"defaultContent": ''
					},
					{
						"data": null, render: function (data, type, row) {
							var links = data.Program_Links.split("; ");
							var names = data.Title.split("; ");

							var strLinks = '';
							for (var i = 0; i < links.length; i++) {

								if (links[i] == null || links[i].trim() === '') strLinks += names[i];
								strLinks += '<a href="' + links[i] + '"  target="_blank">' + names[i] + '</a>; ';
							}

							return strLinks.substr(0, strLinks.length - 2);
						}
					},
					{ "data": "Program_Links" },
					{
						"data": null, render: function (data, type, row) {
							var training_links = data.Training_Links.split("; ");
							var training_names = data.Workforce_Training.split("; ");

							var strTraininglinks = '';
							for (var i = 0; i < training_links.length; i++) {

								if (training_links[i] == null || training_links[i].trim() === '') strTraininglinks += training_names[i];
								strTraininglinks += '<a href="' + training_links[i] + '"  target="_blank">' + training_names[i] + '</a>; ';
							}

							return strTraininglinks.substr(0, strTraininglinks.length - 2);
						}
					},
					{ "data": "Workforce_Training" },
					{ "data": "Training_Links"},
					{
						"data": null, render: function (data, type, row) {
							var state = data.State.split("; ");
							var city = data.City.split("; ");
							

							var strLoc = '';
							var strTmpCity = '';
							for (var i = 0; i < state.length; i++) {

								strTmpCity = '';
								if (!(city[i] == null || city[i].trim() === '')) strTmpCity = ', ' + city[i];
								
								if (i > 0)
									strLoc += ', ' + state[i] + strTmpCity;
								else
									strLoc += state[i] + strTmpCity;

								//End loop and don't list the other states for Nationwide records.
								if (state[0].indexOf("Nationwide") >= 0) i = state.length;
							}

							return strLoc.substr(0, strLoc.length);
						}
					},
					{ "data": "State"}
				],
				"columnDefs": [
					{
						"targets": [0],
						"visible": false
					},
					{
						"targets": [1],
						"title": "Program",
					},
					{
						"targets": [2],
						"title": "Program_Links",
						"visible": false
					},					
					{
						"targets": [3],
						"title": "Workforce Training"
					},

					{
						"targets": [4],
						"title": "Workforce_Training",
						"visible": false
					},
					{
						"targets": [5],
						"title": "Training_Links",
						"visible": false
					},				
					{
						"targets": [6],
						"title": "<nobr>Location</nobr>", 
						"searchable": false
					},
					{
						"targets": [7],
						"title": "State",
						"visible": false
					},

				],
				"createdRow": function (row, data, index) {
					//$('td', row).eq(0).append(format(data));
				},
				"initComplete": function (settings, json) {

					//commented to allow multiselect code to bind to select				
					//setup_select_filter('program_select', '#program_div', objColumn['Program_Area'], true);
					//setup_select_filter('award_select', '#award_div', objColumn['Award_Type'], false);
					//setup_select_filter('recipient_select', '#recipient_div', objColumn['Recipient_Type'], false);
					//setup_select_filter('status_select', '#status_div', objColumn['Status'], false);

					var options = $('#recipient_select option');
					$(options[3]).insertBefore($(options[1]));
					$(options[5]).insertBefore($(options[1]));
					$(options[4]).insertAfter($(options[1]));

					$('#projects-datatable_filter').find('input').keyup(function () {
						var searchTerm = $('#projects-datatable_filter').find('input').val();
						updateHeatMap();
						//$('#projects-datatable').DataTable().search('^' + searchTerm + '$');
					});
					// Add event listener for opening and closing details
					$('#projects-datatable tbody').on('click', 'td.details-control', function () {
						var tr = $(this).closest('tr');
						var row = $('#projects-datatable').DataTable().row(tr);

						if (row.child.isShown()) {
							// This row is already open - close it
							row.child.hide();
							tr.removeClass('shown');
						}
						else {
							// Open this row
							row.child(format(row.data())).show();
							tr.addClass('shown');
						}
					});
				}
			});

			// initialize state filter 
			// $.each(stateCount, function (stateAbbr, count) {
				// if (count > 0) {
					// $('#state_select').append($("<option></option>")
													// .attr("value", stateAbbr)
													// .text(state_list[stateAbbr]));
				// }
			// });

			L.mapbox.accessToken = 'pk.eyJ1IjoiZW5lcmd5IiwiYSI6IkozTG9BZDQifQ.1WKh4U0kKCdknF3gxBOF7Q';

			//var mapid = 'energy.nda103il'; //removed this was old classic tiles api, https://docs.mapbox.com/help/troubleshooting/migrate-legacy-static-tiles-api/
			var mapid = '';
			var map = L.mapbox.map('map', mapid,
			{ maxZoom: 7, minZoom: 1, attributionControl: false, legendControl: { position: 'bottomright' } })
			.setView([40, -96], 5)
			.addLayer(L.mapbox.styleLayer('mapbox://styles/energy/ckhc7eaqv0mjm19p3yr4jtlcw'));

			var featureLayer = L.mapbox.featureLayer();

			// The clusterGroup gets each marker in the group added to it
			// once loaded, and then is added to the map
			var clusterGroup = new L.MarkerClusterGroup({
				showCoverageOnHover: false,
				spiderfyOnMaxZoom: false,
				maxClusterRadius: 0,
			});

			var readyLayer = featureLayer.setGeoJSON(statesMarkers);
			var markerLayerIDs = [];
			
			//  bind events to map for style on features
			var statesLayer0 = L.geoJson(statesData0, {
				style: getStyle0,
				onEachFeature: onEachFeature0,
			}).addTo(map);
			
			var layerID = statesLayer0._leaflet_id;
			
			customPopup(readyLayer, markerLayerIDs);

			function customPopup(markersLayer, markerLayerIDs) {
				markerLayerIDs = [];
				markersLayer.eachLayer(function (layer) {

					var stateAbbreviation = layer.feature.properties.abbreviation;
					var numberOfProjectsPerState = stateCount[stateAbbreviation].toString();

					layer.setIcon(L.mapbox.marker.icon({
						'marker-size': 'small',
						'marker-color': '#FFBA4F',
						'marker-symbol': numberOfProjectsPerState,
					}));
					
					clusterGroup.addLayer(layer);

					markerLayerIDs.push(layer._leaflet_id);
					
				});
				markersLayer.on('click', function (e) {
					
					//var stateAbbreviation = e.layer.feature.properties.abbreviation;
					//console.log('click on' + stateAbbreviation);
					//var state_count = stateCount[stateAbbreviation];
					
					//$('#state_div .dropdown-menu :checkbox[value="' + stateAbbreviation + '"]').prop("checked", "true");
					//$('#state_select').val(stateAbbreviation);
					//$('#state_select').multiselect('refresh');

					//filter_dt_column($('#projects-datatable').DataTable(), objColumn['State'], '#state_div');
					//updateHeatMap();
				});
			}

			search();

			function search(strFilterName) {

				// get the value of the search input field
				//var stateString = $('#state_select').val().toLowerCase().trim();
				var searchString = ($('#ctrlSearch').find('input').length > 0) ? ($('#ctrlSearch').find('input').val().trim().toLowerCase()) : '';
				featureLayer.setFilter(showSelected);

				// here we're simply comparing the 'state' property of each marker
				// to the search string, seeing whether the former contains the latter.
				// If this symbol is in the list, return true. if not, return false.
				// The 'in' operator in javascript does exactly that: given a string
				// or number, it says if that is in a object.
				// 2 in { 2: true } // true
				// 2 in { } // false
				function showSelected(feature) {
					var stateAbbreviation = feature.properties.abbreviation;
					var numberOfProjects = stateCount[stateAbbreviation];

					return (numberOfProjects > 0 ? true : false);
				}

				//clean up current map, remove the current clustered layer
				map.removeLayer(clusterGroup);

				//reinitialize cluster group
				clusterGroup = new L.MarkerClusterGroup({
					showCoverageOnHover: false,
					spiderfyOnMaxZoom: false,
					maxClusterRadius: 2,
				});

				//update layers with new filtered data
				customPopup(featureLayer, markerLayerIDs);

				//if (stateString != '') { map.fitBounds(clusterGroup.getBounds(), { padding: [45, 45] }); }

				map.addLayer(clusterGroup);

				//reset view if user changed the state to 'all'
				//if ((strFilterName == 'state_select' || searchString == '') && (strFilterName.indexOf('option') == -1)) { }
			}

			function getStyle0(feature) {

				var state_count = stateCount[feature.properties.abbreviation];

				var fillOpacityValue = state_count / 37;
				if (state_count <= 4) fillOpacityValue = 0.10;
				if (state_count >= 25) fillOpacityValue = 0.62;

				gradient = {
					weight: 2,
					opacity: 0.5,
					color: 'white',
					fillOpacity: .62,
					fillColor: 'green'
				};

				none = {
					weight: 2,
					opacity: .92,
					color: 'white',
					fillOpacity: 0.1,
					fillColor: 'white'
				};

				if (state_count >= 1)
					return gradient;
				if (state_count == 0)
					return none;
			}

			function onEachFeature0(feature, layer) {
				layer.on({
					click: zoomToFeature,
				});
			}

			var stateAbbreviation;
			function updateStateCount() {

				function checkMultiDropdown(cntl, elem, index, short, exactMatch) {
					var valid = false;

					if (short) return true;

					$(cntl).each(function () {
						var value = $(this).val().trim();
						//if (elem.indexOf(value) >= 0) console.log(value + ' == ' + elem );
						
						elem = elem.trim();
						if (exactMatch == false) 
						{
							if ( elem.indexOf(value) >= 0 ) { valid = true; }
						} 
						else 
							if ( elem == value ) { valid = true; }
					});

					return valid;
				}

				
				// reset state count traking object
				for (var key in stateCount) {
					stateCount[key] = 0;
				}

				// get the value of the search input field
				var searchString = ($('#projects-datatable_filter').find('input').length > 0)
					? ($('#projects-datatable_filter').find('input').val().toLowerCase().trim()) : '';
				var stateString = $('#state_select').val();
				var statusString = $('#status_select').val();

				// count of checked dropdown items 
				var cp = $('#program_div .dropdown-menu input:checked').length;
				var ca = $('#award_div .dropdown-menu input:checked').length;
				var cr = $('#recipient_div .dropdown-menu input:checked').length;
				var cs = $('#state_div .dropdown-menu input:checked').length;
				var ct = $('#status_div .dropdown-menu input:checked').length;

				// total number of options in each dropdown
				var tp = $('#program_select option').length;
				var ta = $('#award_select option').length;
				var tr = $('#recipient_select option').length;
				var ts = $('#state_select option').length;
				var tt = $('#status_select option').length;

				// true if all or none are selected
				var bp = cp == tp || cp == 0;
				var ba = ca == ta || ca == 0;
				var br = cr == tr || cr == 0;
				var bs = cs == ts || cs == 0;
				var bt = ct == tt || ct == 0;

				// filter the full dataset from the inputs
				var filtered = $.grep(objJson.data, function (el, idx) {
					var valid = true;

					var pvalid = checkMultiDropdown('#program_div .dropdown-menu input:checked', el.Program_Links, idx, bp, false);
					var avalid = checkMultiDropdown('#award_div .dropdown-menu input:checked', el.Award_Type, idx, ba);
					var rvalid = checkMultiDropdown('#recipient_div .dropdown-menu input:checked', el.Recipient_Type, idx, br);
					var svalid = checkMultiDropdown('#state_div .dropdown-menu input:checked', el.State, idx, bs, false);
					var tvalid = checkMultiDropdown('#status_div .dropdown-menu input:checked', el.Status, idx, bt, false);
					
					valid = pvalid && avalid && rvalid && svalid && tvalid;

					// use search string to filter map
					if (searchString != '') {
						var words = searchString.split(' ');
						for (var i = 0 ; i < words.length; i++) {
							var w = words[i];
							if ( ((el.Project_Title.toLowerCase().indexOf(w) == -1) // filter by Project Title
							&& (el.Awardee.toLowerCase().indexOf(w) == -1) // filter by Awardee
							&& (el.Program_Links.toLowerCase().indexOf(w) == -1) // filter by Program Area
							&& (el.Recipient_Type.toLowerCase().indexOf(w) == -1) // filter by Recipient Type
							&& (el.Award_Type.toLowerCase().indexOf(w) == -1) // filter by Award Type
							&& (el.FOA_Name.toLowerCase().indexOf(w) == -1) // filter by FOA Name
							&& (el.Fiscal_Year_Awarded.toLowerCase().indexOf(w) == -1) // filter by Fiscal Year Awarded
							&& (el.Project_Description.toLowerCase().indexOf(w) == -1) // filter by Project Description
							&& (el.Status.toLowerCase().indexOf(w) == -1) // filter by Status
							&& (el.State.toLowerCase().indexOf(w) == -1) // filter by State
							))
								valid = false;
						}
					}
					
					//if (true) console.log( idx + " is " + valid + ": " + el.Project_Title.substr(0, 5) + ' in ' + el.State );
					
					return valid;
				});

				// update the count array
				var opts = $('#state_div .dropdown-menu input:checked').toArray();
				$.each(filtered, function (key, objArr) {
					$.each(objArr, function (name, value) {
						if (name == "State") {
							//console.log(name + ": " + value);
							var arrState = value.split("; ");
							for (var i = 0; i < arrState.length; i++) {

								if ( opts.length == 0 ) {
									stateCount[arrState[i].trim()]++;
								}
								else {
									$(opts).each( function () {
										var value = $(this).val();
										if (value == arrState[i].trim()) {
											stateCount[arrState[i].trim()]++;
										}
									});
								}								
							}
						}

					});
				});

			}

			//var layerID = statesLayer0._leaflet_id;
			function updateHeatMap() {

				updateStateCount();

				//remove the previous heat map and previous marker layers
				map.eachLayer(function (layer) {
					//console.log(layer._leaflet_id + '|' + layerID);
					if (layer._leaflet_id == layerID)
						map.removeLayer(layer);
					for (var i = 0; i < markerLayerIDs.length; i++) {
						if (layer._leaflet_id == markerLayerIDs[i])
							map.removeLayer(layer);
					}
				});
				// reassign layer to map
				var statesLayer0 = L.geoJson(statesData0, {
					style: getStyle0,
					onEachFeature: onEachFeature0,
				}).addTo(map);
				layerID = statesLayer0._leaflet_id;

				// only show markers with more than one project 
				search();
				customPopup(featureLayer);
			}

			function updateDataTable() {
			
				$('#projects-datatable').DataTable().search('').columns().search('').draw();
				
				if ($('#program_div :checked').length != 0 ) filter_dt_column($('#projects-datatable').DataTable(), objColumn['Progam_Links'], '#program_div');
				if ($('#award_div :checked').length != 0 ) filter_dt_column($('#projects-datatable').DataTable(), objColumn['Award_Type'], '#award_div');
				if ($('#recipient_div :checked').length != 0 ) filter_dt_column($('#projects-datatable').DataTable(), objColumn['Recipient_Type'], '#recipient_div');
				if ($('#state_div :checked').length != 0) filter_dt_column($('#projects-datatable').DataTable(), objColumn['State'], '#state_div');
				if ($('#status_div :checked').length != 0) filter_dt_column($('#projects-datatable').DataTable(), objColumn['Status'], '#status_div');
			}

			function search_dt_column(dtable, col, cntl) {
				var val = $(cntl).val();
				dtable.column(col).search(val, false, true, true).draw();
			}

			function filter_dt_column(dtable, col, control) {
				var aryCheckVals = [];
				$(control + ' input:checked').each(function () {
					var value = $(this).val();
					//console.log(value);
					aryCheckVals.push(value);
				});
				var strSelectedVals = aryCheckVals.join('|');
				strSelectedVals = strSelectedVals.replace(/\./g, "\\.");
				//console.log(strSelectedVals);

				dtable.column(col)
						.search(strSelectedVals, true, false)
						.draw();
			}

			function zoomToFeature(e) {
				stateAbbreviation = e.target.feature.properties.abbreviation;
				//console.log('zoom to ' + stateAbbreviation);
				
				var state_count = stateCount[stateAbbreviation];
				//if (state_count == 0) return;
				$('#state_select').val(stateAbbreviation);
				$('#state_select').multiselect('refresh');
				filter_dt_column($('#projects-datatable').DataTable(), objColumn['State'], '#state_div');
				
				updateHeatMap();
			}
			
			function resetMap () {
				$("#projects-datatable_filter").find('input').val('');
				$('#state_select').val('All');  stateAbbreviation = 'All';
				$('#status_select').val('All');
				
				$('input:checkbox').prop('checked', false)
				$('#multiSelectGroup select option:selected').prop('selected', false);
				
				updateHeatMap();
				$('#projects-datatable').DataTable().search('').columns().search('').draw();
				map.setView([40, -96], 4);
			}

			$("#btnReset").click(resetMap);
			
			resetMap();

			$('#multiSelectGroup #program_select').multiselect({ 
				nonSelectedText: 'Select Areas', 
				enableClickableOptGroups: true,
				includeSelectAllOption: false,
				buttonWidth: '100%',
				numberDisplayed: 0,
				onChange: function(option, checked, select) {
					//console.log('Changed option ' + $(option).val() + '.');
					updateHeatMap();
					updateDataTable();
				},
				onDeselectAll: function() {
					updateHeatMap();
				}
			});				
			$('#multiSelectGroup #award_select').multiselect({
				nonSelectedText: 'Select Award Type', 
				enableClickableOptGroups: true,
				includeSelectAllOption: false,
				buttonWidth: '100%',
				numberDisplayed: 0,
				onChange: function(option, checked, select) {
					updateHeatMap();
					updateDataTable();
				},
				onDeselectAll: function() {
					updateHeatMap();
				},
			});
			$('#multiSelectGroup #recipient_select').multiselect({
				nonSelectedText: 'Select Recipient Type', 
				enableClickableOptGroups: true,
				includeSelectAllOption: false,
				buttonWidth: '100%',
				numberDisplayed: 0,
				onChange: function(option, checked, select) {
					updateHeatMap();
					updateDataTable();
				},
				onDeselectAll: function() {
					updateHeatMap();
				}
			});
			$('#multiSelectGroup #state_select').multiselect({
				nonSelectedText: 'Select State', 
				enableClickableOptGroups: true,
				includeSelectAllOption: false,
				buttonWidth: '100%',
				buttonText: function(options, select) {
						if (options.length === 0) {
							return 'Select State';
						}
				},
				numberDisplayed: 0,
				onChange: function(option, checked, select) {
					updateHeatMap();
					updateDataTable();
				},
				onDeselectAll: function() {
					updateHeatMap();
				}
			});
			$('#multiSelectGroup #status_select').multiselect({
				nonSelectedText: 'Select Status', 
				enableClickableOptGroups: true,
				includeSelectAllOption: false,
				buttonWidth: '100%',
				numberDisplayed: 0,
				onChange: function(option, checked, select) {
					updateHeatMap();
					updateDataTable();
				},
				onDeselectAll: function() {
					updateHeatMap();
				}
			});

//Setup datatable if there are querystring vars
//todo: handle multiple values for Facets, find a better way to do this, there is a bug if the Value sent in is not unique to all facets
if (Object.keys(qs).length != 0) {
function objLookup (colPresenter) {
var found = false;
for (var k in objColumn) {
if ( k == colPresenter)
found = true;
}
return found;
}

$.each(qs, function (val, key) {
	if ( objLookup(val) ){
		items = key.split('|');
		$.each(items, function(idx, item) {
		//We've hard-coded for program_select only
			$("#program_select").multiselect("select",[key], true);
			filter_dt_column($('#projects-datatable').DataTable(), objColumn[val], '#program_div');
			});
	if (val == "Year") {
		$('#year_group').val(key);
		search_dt_column($('#projects-datatable').DataTable(), objColumn[val], '#year_group');
		}
	} else if ( val == 'Search') {
			$('#datatable_cf_filter').find('input').val(key);
			$('#projects-datatable').DataTable().data().search(key).draw();
		}
	});
} 
			
			$('#program_select, #award_select, #recipient_select, #state_select, #status_select').hide();

			// Custom jump-to control 
			(function () {
				L.Control.Jump = L.Control.extend({
					options: {
						position: 'topleft',
						usTitle: 'Zoom to contiguous US',
						alaskaTitle: 'Zoom to Alaska',
						hawaiiTitle: 'Zoom to Hawaii',
						zoomTitle: 'Zoom to Selections',
						resetTitle: 'View All Projects'
					},

					onAdd: function (map) {
						// set options
						options = this.options;

						// create jump container
						var jumpControl = 'leaflet-control-jump';
						var container = L.DomUtil.create('div', jumpControl + ' leaflet-bar');

						// add buttons
						this._usButton = this._createButton(options.usTitle, jumpControl + '-style-us', container, usAction);
						this._alaskaButton = this._createButton(options.alaskaTitle, jumpControl + '-style-al', container, alaskaAction);
						this._hawaiiButton = this._createButton(options.hawaiiTitle, jumpControl + '-style-hi', container, hiAction);
						//this._zoomTitle = this._createButton(options.zoomTitle, jumpControl + '-style-zoom', container, zoomAction);
						this._resetTitle = this._createButton(options.resetTitle, jumpControl + '-style-reset', container, resetAction);

						return container;
					},

					_createButton: function (title, className, container, fn) {
						var link = L.DomUtil.create('a', className, container);
						link.href = '#';
						link.title = title;
						if (className.indexOf('us') > 0)
							link.innerHTML = '<b style="margin-top:12px;margin-left:5px;color: black;">US</b>';
						if (className.indexOf('al') > 0)
							link.innerHTML = '<b style="margin-top:12px;margin-left:6px;color: black">AK</b>';
						if (className.indexOf('hi') > 0)
							link.innerHTML = '<b style="margin-top:12px;margin-left:6px;color: black">HI</b>';
						if (className.indexOf('zoom') > 0)
							link.innerHTML = '<i class="fa fa-search fa-1" style="margin-top:7px;margin-left:8px;"></i>';
						if (className.indexOf('reset') > 0)
							link.innerHTML = '<i class="fa fa-undo fa-1" style="margin-top:7px;margin-left:8px;"></i>';
						L.DomEvent
							.on(link, 'mousedown dblclick', L.DomEvent.stopPropagation)
							.on(link, 'click', L.DomEvent.stop)
							.on(link, 'click', fn, this)
							.on(link, 'click', this._refocusOnMap, this);

						return link;
					}
				});

				L.control.jump = function (options) {
					return new L.Control.Jump(options);
				};
			})();

			// Create button functionality for jump control
			function usAction() {
				map.setView([40, -96], 4);
			}

			function hiAction() {
				map.fitBounds([[18.542116654448996, -161.03759765625], [22.573438264572406, -154.22607421875]]);
			}

			function alaskaAction() {
				map.fitBounds([[51.72702815704774, -170.15625], [71.85622888185527, -127.61718749999999]]);
			}

			function resetAction() {
				window.location.reload();
			}

			// Add custom 'jump to' sidebar
			L.control.jump().addTo(map);

			$('#program_select').addClass('form-control');
			$('#award_select').addClass('form-control');
			$('#recipient_select').addClass('form-control');
			$('#status_select').addClass('form-control');

			$('#projects-datatable_length').find('select').addClass('form-control');
			$('#projects-datatable_filter').find('input').addClass('form-control');
			$('#projects-datatable_paginate').removeClass();
			$('#projects-datatable_paginate').addClass('pagination');

			$('#projects-datatable_info').insertAfter('#projects-datatable_filter');

		});

	});

	function setup_select_filter(strSelectID, strDivID, intCol, blnMulti) {

		var tmpMarkup, tmpLabel, chkBoxMarkup;

		if (!blnMulti) {
			selectMarkup = $('<select id="' + strSelectID + '"></select>').appendTo($(strDivID));
			$('<option value="All">All</option>').appendTo(selectMarkup);

			$('#projects-datatable').DataTable().column(intCol).data().unique().sort().each(function (data, value) {

				var itemValue;
				if (typeof data === 'object') {
					switch (intCol) {
						case objColumn['Recipient_Type']:
							itemValue = data.Recipient_Type.toString().trim();
							break;
						default:
							break;
					}
				}
				else
					itemValue = data.trim();

				if (itemValue == '') return;

				itemMarkup = $('<option />');
				itemMarkup.val(itemValue);

				var newLabel = itemValue;
				itemMarkup.append(newLabel);
				var options = $('#' + strSelectID + ' option');
				var values = $.map(options, function (option) {
					return option.value;
				});

				var flag = false;
				for (var i = 0; i < values.length; i++) {
					if (itemValue == values[i].trim())
						flag = true;
				}
				if (flag == false)
					itemMarkup.appendTo(selectMarkup);
			});
		}
		else {
			//there are multiple values in the column. Separate and find all uniques
			var aryAllValues = [], objAllValues = {};
			$('#projects-datatable').DataTable().column(intCol).data().each(function (d, j) {
				var tmpColumnValue = d, tmpAryValues = [];
				if (typeof tmpColumnValue === 'object') {
					if (objColumn['Program_Links'] == intCol)
						tmpColumnValue = d.Program_Links.toString();
				}

				if (tmpColumnValue.indexOf("; ") > 0) {
					tmpAryValues = tmpColumnValue.split("; ");
					$.each(tmpAryValues, function (key, val) {
						objAllValues[val.trim()] = true;
					});

				}
				else {
					objAllValues[tmpColumnValue.trim()] = true;
				}
			});
			for (var k in objAllValues) { if (k != '') { aryAllValues.push(k); } }
			aryAllValues.sort();

			//Build facet control depending on unique values from the column
			selectMarkup = $('<select/>').attr('id', strSelectID).appendTo($(strDivID));
			$('<option/>').attr('value', 'All').text('All').appendTo(selectMarkup);

			$.each(aryAllValues, function (key, val) {
				itemMarkup = $('<option/>');
				itemMarkup.val(val.trim());
				itemMarkup.append(val.trim());

				var options = $('#' + strSelectID + ' span');
				var values = $.map(options, function (option) {
					return option.value;
				});

				var flag = false;
				for (var i = 0; i < values.length; i++) {
					if (val.trim() == values[i])
						flag = true;
				}
				if (flag == false)
					itemMarkup.appendTo(selectMarkup);
			});

		}
	}
});
</script>

<script src="//www1.eere.energy.gov/apps/js/pym.v1.min.js"></script>
<script src="//www1.eere.energy.gov/apps/js/shim.js"></script>
